{% extends "base.html" %}
{% block content %}

<div class="container mt-5 mb-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h2 class="fw-bold text-primary mb-1">RTI Details</h2>
            <small class="text-muted">
                Department of Rural Development & Panchayat Raj
            </small>
        </div>
        <a href="/" class="btn btn-outline-secondary">
            ‚Üê Back
        </a>
    </div>

    <!-- Basic Information -->
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-primary text-white fw-semibold">
            Basic Information
        </div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <tbody>
                    <tr>
                        <td class="text-muted">Reference Number</td>
                        <td class="fw-semibold fs-5">{{ rti.reference_number }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Applicant Name</td>
                        <td>{{ rti.applicant_name }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Date Filed</td>
                        <td>{{ rti.date_filed|date:"d M Y" }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Subject</td>
                        <td>
                            <div class="p-2 bg-light rounded border">
                                {{ rti.subject }}
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Panchayat</td>
                        <td class="text-primary fw-semibold">
                            {{ rti.panchayat.name }}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Status</td>
                        <td>
                            <span class="badge bg-{{ rti.status_color|default:'secondary' }} px-3 py-2">
                                {{ rti.status }}
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Response Section -->
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-success text-white fw-semibold">
            Response Information
        </div>
        <div class="card-body">

            {% if response %}
                <p><strong>Reply:</strong></p>
                <div class="border rounded p-3 bg-light mb-3">
                    {{ response.reply_text }}
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 fw-semibold">Date Replied:</div>
                    <div class="col-md-8">{{ response.date_replied }}</div>
                </div>

                <div class="row">
                    <div class="col-md-4 fw-semibold">Delayed:</div>
                    <div class="col-md-8">
                        {% if response.is_delayed %}
                            <span class="badge bg-danger">Yes</span>
                        {% else %}
                            <span class="badge bg-success">No</span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning mb-0">
                    ‚è≥ No response submitted yet.
                </div>
            {% endif %}

        </div>
    </div>

    <!-- Analyst Review -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">
            Analyst Review
        </div>
        <div class="card-body">

            {% if review %}
                <div class="mb-3">
                    <strong>Status:</strong>
                    {% if review.status == "COMPLETE" %}
                        <span class="badge bg-success">Complete</span>
                    {% elif review.status == "VAGUE" %}
                        <span class="badge bg-warning text-dark">Vague</span>
                    {% elif review.status == "DENIED" %}
                        <span class="badge bg-dark">Denied</span>
                    {% elif review.status == "DELAYED" %}
                        <span class="badge bg-danger">Delayed</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ review.status }}</span>
                    {% endif %}
                </div>

                <p><strong>Remarks:</strong></p>
                <div class="border rounded p-3 bg-light">
                    {{ review.remarks }}
                </div>

            {% else %}
                <div class="alert alert-info mb-0">
                    No analyst review available yet.
                </div>
            {% endif %}

        </div>
    </div>

    <!-- Documents Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">
            RTI Documents
        </div>
        <div class="card-body">

            {% if rti.original_application %}
                <a href="{{ rti.original_application.url }}"
                   class="btn btn-outline-primary me-2 mb-2"
                   target="_blank">
                    üìÑ Download Original RTI
                </a>
            {% endif %}

            {% if rti.acknowledgement_document %}
                <a href="{{ rti.acknowledgement_document.url }}"
                   class="btn btn-outline-warning me-2 mb-2"
                   target="_blank">
                    üì© Download Acknowledgement
                </a>
            {% endif %}

            {% if rti.response_document %}
                <a href="{{ rti.response_document.url }}"
                   class="btn btn-outline-success me-2 mb-2"
                   target="_blank">
                    üìÑ Download Response
                </a>
            {% endif %}

            {% if not rti.original_application and not rti.acknowledgement_document and not rti.response_document %}
                <div class="alert alert-secondary mb-0">
                    No documents uploaded yet.
                </div>
            {% endif %}

        </div>
    </div>

    <!-- Appeals Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white fw-semibold">
            Appeals
        </div>
        <div class="card-body">

            {% if first_appeal %}

                <div class="mb-3">
                    <h6 class="fw-bold">First Appeal</h6>
                    <p><strong>Reference:</strong> {{ first_appeal.reference_number }}</p>
                    <p>
                        <strong>Status:</strong>
                        <span class="badge 
                            {% if first_appeal.status == 'PENDING' %} bg-warning text-dark
                            {% elif first_appeal.status == 'UNDER_REVIEW' %} bg-info
                            {% elif first_appeal.status == 'DECIDED' %} bg-success
                            {% else %} bg-secondary
                            {% endif %}">
                            {{ first_appeal.get_status_display }}
                        </span>
                    </p>
                </div>

                {% if second_appeal %}
                    <div>
                        <h6 class="fw-bold">Second Appeal</h6>
                        <p><strong>Reference:</strong> {{ second_appeal.reference_number }}</p>
                        <p>
                            <strong>Status:</strong>
                            <span class="badge 
                                {% if second_appeal.status == 'PENDING' %} bg-warning text-dark
                                {% elif second_appeal.status == 'UNDER_REVIEW' %} bg-info
                                {% elif second_appeal.status == 'DECIDED' %} bg-success
                                {% else %} bg-secondary
                                {% endif %}">
                                {{ second_appeal.get_status_display }}
                            </span>
                        </p>
                    </div>
                {% else %}
                    <a href="{% url 'file_second_appeal' first_appeal.id %}"
                       class="btn btn-outline-primary">
                        File Second Appeal
                    </a>
                {% endif %}

            {% else %}
                {% if can_file_first %}
                    <a href="{% url 'file_first_appeal' rti.id %}"
                       class="btn btn-primary">
                        File First Appeal
                    </a>
                {% else %}
                    <div class="alert alert-secondary mb-0">
                        First Appeal can be filed 30 days after RTI filing date.
                    </div>
                {% endif %}
            {% endif %}

        </div>
    </div>

    <!-- Admin API Button -->
    {% if request.user.is_staff %}
    <div class="text-end mt-3">
        <a href="{% url 'api_rti' %}"
           class="btn btn-warning shadow-sm">
            View All RTI (Admin API)
        </a>
    </div>
    {% endif %}

</div>

{% endblock %}